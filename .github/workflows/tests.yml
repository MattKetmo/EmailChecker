name: CI

on:
    push:
        branches: [master]
    pull_request:

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                php-version:
                    - '8.0'
                    - '8.1'
                    - '8.2'
                    - '8.3'
                    - '8.4'
                dependencies: [highest]
                symfony-require: ['']
                include:
                    - php-version: '8.0'
                      dependencies: lowest
                    - php-version: '8.1'
                      symfony-require: '5.4.*'
                    - php-version: '8.2'
                      symfony-require: '6.4.*'
                    - php-version: '8.3'
                      symfony-require: '7.2.*'
                    - php-version: '8.4'
                      symfony-require: '8.0.*'
                      stability: dev

        name: PHP ${{ matrix.php-version }} ${{ matrix.symfony-require && format('/ Symfony {0}', matrix.symfony-require) || '' }} ${{ matrix.dependencies == 'lowest' && '/ lowest' || '' }}

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony-require }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-version }}
                  tools: composer:v2, flex
                  coverage: none

            - name: Allow dev stability
              if: matrix.stability == 'dev'
              run: composer config minimum-stability dev

            - name: Install Composer dependencies
              uses: ramsey/composer-install@v3
              with:
                  dependency-versions: ${{ matrix.dependencies }}

            - name: Run tests
              run: composer test

    lint:
        runs-on: ubuntu-latest

        name: PHP Cs Fixer

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.5
                    coverage: none

            -   name: Install Composer dependencies
                uses: ramsey/composer-install@v3

            -   name: Run lint
                run: composer lint

    phpstan:
        runs-on: ubuntu-latest

        name: PHPStan

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.5
                    coverage: none

            -   name: Install Composer dependencies
                uses: ramsey/composer-install@v3

            -   name: Run phpstan
                run: composer phpstan
